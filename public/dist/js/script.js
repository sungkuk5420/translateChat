function makeList(e){for(var t=["banana","apple","grape","orange"],a=0;a<t.length;a++)e.push(t[a])}function getLastFromList(e,t){e.limit(1).once("child_added",function(e){t(e.val())})}function go(){var e=new Firebase("https://chat-67329.firebaseio.com");makeList(e),getLastFromList(e,function(e){})}var chat=void 0,CHATDATABASE=void 0,app;$(document).ready(function(){var e;e=function(e){return this.text=e.text,this.message_side=e.message_side,this.draw=function(e){return function(){var t;return(t=$($(".message").clone().html())).addClass(e.message_side).find(".text").html(e.text),$("#chat-messages").append(t),setTimeout(function(){return t.addClass("appeared")},0)}}(this),this};var t,a,s;$(function(){a="right",t=function(){var e,t=(e=$(".message_input")).val();e.val("");return function(e){var t=$.Deferred();try{textTranslate({sendText:e,checkKey:!1,autoKey:!0,resultLang:"ja",cb:function(e){t.resolve(e)}})}catch(e){t.reject(e)}return t.promise()}(t).done(function(e){return e}).fail(function(t){return e.val()}).always(function(){})},s=function(t,a){var s;if(""!==t.trim())return $(".message_input").val(""),s=$(".messages"),new e({text:t,message_side:a}).draw(),s.animate({scrollTop:s.prop("scrollHeight")},300)},$(".send_message").click(function(e){if(""!==$(".message_input").val())return t().then(function(e){chat.pushData(chat.userName,e.sendText)})}),$(".message_input").keyup(function(e){if(13===e.which&&""!==$(".message_input").val())return t().then(function(e){chat.pushData(chat.userName,e.sendText)})})}),(chat={defaultChat:"/public",thisChatList:void 0,userName:void 0,init:function(){chat.userName="abc",chat.getDatabase(function(){CHATDATABASE.ref(chat.defaultChat).limitToLast(1).on("child_added",function(e){var t=e.val(),a=DBData.filter(function(e){return e.data.sendText===t.sendText});if(0!=a.length){var s={id:e.key.replace(/-/gi,"").replace(/_/gi,""),userName:t.userName,sendText:t.sendText,translateText:a[0].data.ja,msgType:t.userName==chat.userName?"my":"other",timeStamp:t.timeStamp};0===app._data.messages.filter(function(t){return t.id===e.key.replace(/-/gi,"").replace(/_/gi,"")}).length&&app.addItem(s)}else textTranslate({sendText:t,resultLang:"ja",autoKey:!0,cb:function(e){var a={id:e.key.replace(/-/gi,"").replace(/_/gi,""),userName:t.userName,sendText:t.sendText,translateText:e.ja,msgType:t.userName==chat.userName?"my":"other",timeStamp:t.timeStamp};0===app._data.messages.filter(function(t){return t.id===e.key.replace(/-/gi,"").replace(/_/gi,"")}).length&&app.addItem(a)}})}),chat.thisChatList.forEach(function(e,t){var a=e.data,s=DBData.filter(function(e){return e.data.sendText===a.sendText});if(0!=s.length){var n={id:e.id.replace(/-/gi,"").replace(/_/gi,""),userName:a.userName,sendText:a.sendText,translateText:s[0].data.ja,msgType:a.userName==chat.userName?"my":"other",timeStamp:a.timeStamp};0===app._data.messages.filter(function(t){return t.id===e.id.replace(/-/gi,"").replace(/_/gi,"")}).length&&app.addItem(n)}else textTranslate({sendText:a.sendText,resultLang:"ja",autoKey:!0,cb:function(t){var s={id:e.id.replace(/-/gi,"").replace(/_/gi,""),userName:a.userName,sendText:a.sendText,translateText:t.ja,msgType:a.userName==chat.userName?"my":"other",timeStamp:a.timeStamp};0===app._data.messages.filter(function(t){return t.id===e.id.replace(/-/gi,"").replace(/_/gi,"")}).length&&app.addItem(s)}})})})},getDatabase:function(e){(CHATDATABASE=firebase.database()).ref(chat.defaultChat).on("value",function(e){var t=e.val();chat.thisChatList=Object.keys(t).map(function(e){return{id:e,data:t[e]}})}),setTimeout(function(){e&&e()},0)},pushData:function(e,t){CHATDATABASE.ref(chat.defaultChat).child("/").push({userName:e,sendText:t,timeStamp:moment().format("YYYY-MM-DD,h:mm:ss")})},scrollDown:function(){$(".chat-messages").scrollTop($(".chat-messages")[0].scrollHeight)}}).init(),app=new Vue({el:"#chatbox",data:{messages:[]},methods:{addItem:function(e){this.messages.push(e),this.scrollToEnd()},scrollToEnd:function(){var e=this;setTimeout(function(){var t=e.$el.querySelector("#chat-messages");t.scrollTop=t.scrollHeight},0)}}}),document.createElement("img").src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/timeline1.png",$("#searchfield").focus(function(){"Search contacts..."==$(this).val()&&$(this).val("")}),$("#searchfield").focusout(function(){""==$(this).val()&&$(this).val("Search contacts...")}),$("#sendmessage .message_input").focus(function(){"Send message..."==$(this).val()&&$(this).val("")}),$("#sendmessage .message_input").focusout(function(){""==$(this).val()&&$(this).val("Send message...")}),$(".friend").each(function(){$(this).click(function(){var e=$(this).offset(),t=$(this).parent().parent().offset(),a=e.top-t.top,s=$(this).find("img").eq(0).clone(),n=a+12+"px";$(s).css({top:n}).addClass("floatingImg").appendTo("#chatbox"),setTimeout(function(){$("#profile p").addClass("animate"),$("#profile").addClass("animate")},100),setTimeout(function(){$("#chat-messages").addClass("animate"),$(".cx, .cy").addClass("s1"),setTimeout(function(){$(".cx, .cy").addClass("s2")},100),setTimeout(function(){$(".cx, .cy").addClass("s3")},200)},150),$(".floatingImg").animate({width:"68px",left:"50%",top:"20px","margin-left":"-34px"},200);var i=$(this).find("p strong").html(),r=$(this).find("p span").html();$("#profile p").html(i),$("#profile span").html(r),$(".message").not(".right").find("img").attr("src",$(s).attr("src")),$("#friendslist").fadeOut(),$("#chatview").fadeIn(),$("#chat-messages").css("height",$("#chatview").height()-153+"px"),$("#close").unbind("click").click(function(){$("#chat-messages, #profile, #profile p").removeClass("animate"),$(".cx, .cy").removeClass("s1 s2 s3"),$(".floatingImg").animate({width:"40px",top:n,left:"12px"},200,function(){$(".floatingImg").remove()}),setTimeout(function(){$("#chatview").fadeOut(),$("#friendslist").fadeIn()},50)})})}),function(e){function t(){e("#chat-messages").css("height",e("#chatview").height()-153+"px")}var a;e(window).resize(function(){clearTimeout(a),a=setTimeout(t,250)})}(jQuery)});
function changeDBText(t,a,e){var n="",i="",o="",r="";if(void 0===e||""===e){var d=getTextData(t,"ja");e=d.data,n=d.lang}"ko"===n?(i=a,o=e.data.ja):"ja"===n&&(o=a,i=e.data.ko),r=e.data.sendText===t?"ko"===BASELANG?a:"ja"===BASELANG?a:e.data.sendText:e.data.sendText,DATABASE.ref(defaultPath).child("/"+e.id).set({sendText:r,ja:o,ko:i}),$("#txtArea").val(""),$(".changeTextObj").text(a),$("#mypopup").removeClass("show")}function textTranslate(t){function a(n){void 0!==n[0]&&p(n[0]).then(function(i){var o="ko"==t.resultLang?i.ko:i.ja;t.cb&&t.cb(i),$("[data-langtext]").each(function(){var t=$(this);$.trim(t.text())===n[0]&&t.text(o)}),n=e(n,n[0]),BASELANG="ko"===t.resultLang?"ja":"ko",a(n)},function(t){})}function e(t,a){for(var e=t.length;e--;)t[e]&&t[e]===a&&t.splice(e,1);return t}function n(t,a){if(void 0!==t&&""!==t){if("ko"==a){if(""==t.data.ko)return!0}else if("ja"==a&&""==t.data.ja)return!0;return!1}return!0}var i=BASELANG,o="ko"===t.resultLang?"ko":"ja",r=!0===t.checkKey,d=!0===t.autoKey;"ko"==o&&(i="ja",o="ko");var p=function(t){return new Promise(function(a,e){function p(a,e,n){if("ja"==e){c=a;i=1==r?"":t}else if("ko"==e){var i=a;c=1==r?"":t}s(t,i,c,u)}function s(t,e,n,i){if(void 0!==i&&""!==i){var o="";return""!==n?o=i.data.ko:""!==e&&(o=i.data.ja),changeDBText("",o,i),!1}DATABASE.ref(defaultPath).child("/").push({sendText:t,ja:n,ko:e},function(i){i||a({sendText:t,ja:n,ko:e})})}var u=getTextData(t,o).data;if(n(u,o)){var c="";translateAPI(t,i,o,function(a){var e=a.translatedText;a.srcLangType;if(t==e&&1==d)return n(getTextData(t,i).data,o)&&translateAPI(t,o,i,function(t){p(t.translatedText,o)}),!1;p(e,o)})}else a(u.data)})};if(t.sendText)p(t.sendText).then(function(a){t.cb&&t.cb(a),BASELANG="ko"===t.resultLang?"ja":"ko"},function(t){});else if(void 0===t.sendText){var s=[];$("[data-langtext]").each(function(){var t=$(this),a=$.trim(t.text());s.push(a)}),a(s)}}function translateAPI(t,a,e,n){$.ajax({type:"GET",beforeSend:function(t){t.setRequestHeader("content-type","text/javascript")},url:"/translate",data:{text:t,sendLang:a,resultLang:e},dataType:"json",contentType:"application/json; charset=utf-8",success:function(t){var t=JSON.parse(t);n&&n(t.message.result)}})}function getTextData(t,a){var e=[],n="";return"ko"==a?(e=DBData.filter(function(a){return a.data.ja===t}),n="ja"):"ja"==a&&(e=DBData.filter(function(a){return a.data.ko===t}),n="ko"),0!==e.length?{data:e[0],lang:n}:(e=DBData.filter(function(a){return(void 0!==a.data.sendText?$.trim(a.data.sendText):void 0)===t}),n="sendText","ko"==a?(e=DBData.filter(function(a){return(void 0!==a.data.ko?$.trim(a.data.ko):void 0)===t}),n="ko"):"ja"==a&&(e=DBData.filter(function(a){return(void 0!==a.data.ja?$.trim(a.data.ja):void 0)===t}),n="ja"),0!==e.length&&("ko"==a&&""===e[0].data.ko||"ja"==a&&""===e[0].data.ja)&&(e=[]),1===e.length?{data:e[0],lang:n}:{data:"",lang:""})}function translateInit(t){getDataBase("cbTrue").then(function(a){addClickCss(),addPopupHTML(),t&&t()},function(t){})}function addClickCss(){var t="<style type='text/css'> ";t+=".langClickCss:hover{ background-color:#ddd; font-weight:bold; curser: pointer;}",t+=" </style>",$("head").append(t),$("[data-langtext]").addClass("langClickCss"),$(".langClickCss").click(function(){$(this).addClass("changeTextObj");var t=getTextData($.trim($(this).text()),BASELANG);""===t.data&&""===t.lang||popupOpen($(this).text())})}function addPopupHTML(){var t="<style type='text/css'> ",a="<style type='text/css'> ";t+=".popup-ui { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: 7777; opacity: 0; visibility: hidden; background: rgba(0, 0, 0, 0.5); text-align: center; transition: all 0.2s ease-in-out; }",t+=".popup-ui:before { content: ''; display: inline-block; height: 100%; vertical-align: middle; }",t+=".popup-ui .popup-ui-wrapper { position: relative; display: inline-block; vertical-align: middle; margin: 0 auto; text-align: left; max-width:90%; }",t+=".popup-ui .popup-ui-wrapper .popup-ui-content { position: relative; background: #FFF; padding: 0; width: auto; margin: 0 auto; opacity: 0; visibility: hidden; border: solid 5px #FFF; width:100%; transition: all 0.2s ease-in-out; transform: scale(0.8); box-shadow: 0 0 5px 2px rgba(0, 0, 0, 0.5); }",t+=".popup-ui.show { opacity: 1; visibility: visible; }",t+=".popup-ui.show .popup-ui-content { opacity: 1; visibility: visible; transform: scale(1); }",t+=".my-content img { max-width: 100%; height: auto; }",t+=".my-content h3 { padding: 0 10px; font-weight: 300; margin-bottom: 0; }",t+=".my-content p { padding: 0 10px; font-size: 0.9em; }",t+="#btnpopup { display: block; margin: 2em auto 0 auto; width: 200px; }",t+=" </style>",a="<style type='text/css'> ",a+=" #txtArea { width: 100%; margin-top: 10px; padding: 10px;}",a+=" </style>",$("body").append('<div id="mypopup" class="popup-ui"><div class="popup-ui-wrapper"><div class="popup-ui-content"><div class="my-content"><h3 class="textString"></h3><textarea  id="txtArea" rows="4" onkeypress="enterKeyEvent();" ></textarea></div></div></div></div>'),$("head").append(t),$("head").append(a);document.getElementById("btnpopup");document.getElementById("mypopup").addEventListener("click",function(){0==$(event.target).closest(".popup-ui-wrapper").length&&(this.className="popup-ui",$(".changeTextObj").removeClass("changeTextObj"))},!1)}function popupOpen(t){document.getElementById("mypopup").className="popup-ui  show",$("#mypopup").find(".textString").text(t),$("#mypopup").find(".inputForm").attr("placeholder",t)}function enterKeyEvent(){if(13===window.event.keyCode)return event.shiftKey||(changeDBText($.trim($(".textString").text()),$.trim($("#txtArea").val())),event.preventDefault()),!1}var DBData=void 0,config={apiKey:"AIzaSyDApewjUdAfz8duov7fUg4Qxz4rBcPwDA8",authDomain:"chat-67329.firebaseapp.com",databaseURL:"https://chat-67329.firebaseio.com",projectId:"chat-67329",storageBucket:"chat-67329.appspot.com",messagingSenderId:"29394740351"};firebase.initializeApp(config);var BASELANG="ko",DATABASE=void 0,defaultPath="/translate",getDataBase=function(t){return new Promise(function(a,e){(DATABASE=firebase.database()).ref(defaultPath).on("value",function(e){var n=e.val();DBData=Object.keys(n).map(function(t){return{id:t,data:n[t]}}),t&&a(DBData)})})};
$(document).ready(function(){translateInit(function(){chat.init()})});