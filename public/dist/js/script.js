var socket=io.connect("http://localhost:3000");(function(){var e;e=function(e){return this.text=e.text,this.message_side=e.message_side,this.draw=function(e){return function(){var t;return(t=$($(".message_template").clone().html())).addClass(e.message_side).find(".text").html(e.text),$(".messages").append(t),setTimeout(function(){return t.addClass("appeared")},0)}}(this),this};var t,n,s;$(function(){n="right",t=function(){var e;return function(e){var t=$.Deferred();try{textTranslate({sendText:e,checkKey:!1,autoKey:!0,resultLang:"ja",cb:function(e){t.resolve(e)}})}catch(e){t.reject(e)}return t.promise()}((e=$(".message_input")).val()).done(function(e){return e}).fail(function(t){return e.val()}).always(function(){})},s=function(t,n){var s;if(""!==t.trim())return $(".message_input").val(""),s=$(".messages"),new e({text:t,message_side:n}).draw(),s.animate({scrollTop:s.prop("scrollHeight")},300)},$(".send_message").click(function(e){return t().then(function(e){socket.emit("message",e)})}),$(".message_input").keyup(function(e){if(13===e.which)return t().then(function(e){socket.emit("message",e)})})}),socket.on("my message",function(e,t){s(t.sendText+"<br>"+t.ja,"right")}),socket.on("other message",function(e,t){s(t.sendText+"<br>"+t.ja,"left")})}).call(this),$(document).ready(function(){$(".messages").css("height",$(".chat_window")[0].offsetHeight-($(".bottom_wrapper")[0].offsetHeight+$(".top_menu")[0].offsetHeight)+"px")});
function changeDBText(t,e,a){var n="",i="",o="",r="";if(void 0===a||""===a){var s=getTextData(t,"ja");a=s.data,n=s.lang}"ko"===n?(i=e,o=a.data.ja):"ja"===n&&(o=e,i=a.data.ko),r=a.data.sendText===t?"ko"===BASELANG?e:"ja"===BASELANG?e:a.data.sendText:a.data.sendText,firebase.database().ref().child("/"+a.id).set({sendText:r,ja:o,ko:i}),$("#txtArea").val(""),$(".changeTextObj").text(e),$("#mypopup").removeClass("show")}function textTranslate(t){function e(n){void 0!==n[0]&&p(n[0]).then(function(i){var o="ko"==t.resultLang?i.ko:i.ja;t.cb&&t.cb(i),$("[data-langtext]").each(function(){var t=$(this);$.trim(t.text())===n[0]&&t.text(o)}),n=a(n,n[0]),BASELANG="ko"===t.resultLang?"ja":"ko",e(n)},function(t){})}function a(t,e){for(var a=t.length;a--;)t[a]&&t[a]===e&&t.splice(a,1);return t}function n(t,e){if(void 0!==t&&""!==t){if("ko"==e){if(""==t.data.ko)return!0}else if("ja"==e&&""==t.data.ja)return!0;return!1}return!0}var i=BASELANG,o="ko"===t.resultLang?"ko":"ja",r=!0===t.checkKey,s=!0===t.autoKey;"ko"==o&&(i="ja",o="ko");var p=function(t){return new Promise(function(e,a){function p(e,a){if("ja"==a){c=e;n=1==r?"":t}else if("ko"==a){var n=e;c=1==r?"":t}d(t,n,c,u)}function d(t,a,n,i){if(void 0!==i&&""!==i){var o="";return""!==n?o=i.data.ko:""!==a&&(o=i.data.ja),changeDBText("",o,i),!1}firebase.database().ref().child("/").push({sendText:t,ja:n,ko:a},function(i){i||e({sendText:t,ja:n,ko:a})})}var u=getTextData(t,o).data;if(n(u,o)){var c="";translateAPIGoogle(t,i,o,function(e){var a=e.translatedText;e.srcLangType;if(t==a&&1==s)return n(getTextData(t,i).data,o)&&translateAPIGoogle(t,o,i,function(t){p(t.translatedText,o)}),!1;p(a,o)})}else e(u.data)})};if(t.sendText)p(t.sendText).then(function(e){t.cb&&t.cb(e),BASELANG="ko"===t.resultLang?"ja":"ko"},function(t){});else if(void 0===t.sendText){var d=[];$("[data-langtext]").each(function(){var t=$(this),e=$.trim(t.text());d.push(e)}),e(d)}}function translateAPI(t,e,a,n){$.ajax({type:"GET",beforeSend:function(t){t.setRequestHeader("content-type","text/javascript")},url:"/translate",data:{text:t,sendLang:e,resultLang:a},dataType:"json",contentType:"application/json; charset=utf-8",success:function(t){var t=JSON.parse(t);n&&n(t.message.result)}})}function translateAPIGoogle(t,e,a,n){$.ajax({type:"GET",beforeSend:function(t){t.setRequestHeader("content-type","text/javascript")},url:"/translateGoogle",data:{text:t,sendLang:e,resultLang:a},dataType:"json",contentType:"application/json; charset=utf-8",success:function(t){var e={srcLangType:t.from.language.iso,translatedText:t.text};n&&n(e)}})}function getTextData(t,e){var a=[],n="";return"ko"==e?(a=DBData.filter(function(e){return e.data.ja===t}),n="ja"):"ja"==e&&(a=DBData.filter(function(e){return e.data.ko===t}),n="ko"),0!==a.length?{data:a[0],lang:n}:(a=DBData.filter(function(e){return(void 0!==e.data.sendText?$.trim(e.data.sendText):void 0)===t}),n="sendText","ko"==e?(a=DBData.filter(function(e){return(void 0!==e.data.ko?$.trim(e.data.ko):void 0)===t}),n="ko"):"ja"==e&&(a=DBData.filter(function(e){return(void 0!==e.data.ja?$.trim(e.data.ja):void 0)===t}),n="ja"),0!==a.length&&("ko"==e&&""===a[0].data.ko||"ja"==e&&""===a[0].data.ja)&&(a=[]),1===a.length?{data:a[0],lang:n}:{data:"",lang:""})}function translateInit(){getDataBase("cbTrue").then(function(t){addClickCss(),addPopupHTML()},function(t){})}function addClickCss(){var t="<style type='text/css'> ";t+=".langClickCss:hover{ background-color:#ddd; font-weight:bold; curser: pointer;}",t+=" </style>",$("head").append(t),$("[data-langtext]").addClass("langClickCss"),$(".langClickCss").click(function(){$(this).addClass("changeTextObj");var t=getTextData($.trim($(this).text()),BASELANG);""===t.data&&""===t.lang||popupOpen($(this).text())})}function addPopupHTML(){var t="<style type='text/css'> ",e="<style type='text/css'> ";t+=".popup-ui { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: 7777; opacity: 0; visibility: hidden; background: rgba(0, 0, 0, 0.5); text-align: center; transition: all 0.2s ease-in-out; }",t+=".popup-ui:before { content: ''; display: inline-block; height: 100%; vertical-align: middle; }",t+=".popup-ui .popup-ui-wrapper { position: relative; display: inline-block; vertical-align: middle; margin: 0 auto; text-align: left; max-width:90%; }",t+=".popup-ui .popup-ui-wrapper .popup-ui-content { position: relative; background: #FFF; padding: 0; width: auto; margin: 0 auto; opacity: 0; visibility: hidden; border: solid 5px #FFF; width:100%; transition: all 0.2s ease-in-out; transform: scale(0.8); box-shadow: 0 0 5px 2px rgba(0, 0, 0, 0.5); }",t+=".popup-ui.show { opacity: 1; visibility: visible; }",t+=".popup-ui.show .popup-ui-content { opacity: 1; visibility: visible; transform: scale(1); }",t+=".my-content img { max-width: 100%; height: auto; }",t+=".my-content h3 { padding: 0 10px; font-weight: 300; margin-bottom: 0; }",t+=".my-content p { padding: 0 10px; font-size: 0.9em; }",t+="#btnpopup { display: block; margin: 2em auto 0 auto; width: 200px; }",t+=" </style>",e="<style type='text/css'> ",e+=" #txtArea { width: 100%; margin-top: 10px; padding: 10px;}",e+=" </style>",$("body").append('<div id="mypopup" class="popup-ui"><div class="popup-ui-wrapper"><div class="popup-ui-content"><div class="my-content"><h3 class="textString"></h3><textarea  id="txtArea" rows="4" onkeypress="enterKeyEvent();" ></textarea></div></div></div></div>'),$("head").append(t),$("head").append(e);document.getElementById("btnpopup");document.getElementById("mypopup").addEventListener("click",function(){0==$(event.target).closest(".popup-ui-wrapper").length&&(this.className="popup-ui",$(".changeTextObj").removeClass("changeTextObj"))},!1)}function popupOpen(t){document.getElementById("mypopup").className="popup-ui  show",$("#mypopup").find(".textString").text(t),$("#mypopup").find(".inputForm").attr("placeholder",t)}function enterKeyEvent(){if(13===window.event.keyCode)return event.shiftKey||(changeDBText($.trim($(".textString").text()),$.trim($("#txtArea").val())),event.preventDefault()),!1}var DBData=void 0,config={apiKey:"AIzaSyDApewjUdAfz8duov7fUg4Qxz4rBcPwDA8",authDomain:"chat-67329.firebaseapp.com",databaseURL:"https://chat-67329.firebaseio.com",projectId:"chat-67329",storageBucket:"chat-67329.appspot.com",messagingSenderId:"29394740351"};firebase.initializeApp(config);var BASELANG="ko",DATABASE=void 0,getDataBase=function(t){return new Promise(function(e,a){(DATABASE=firebase.database()).ref().on("value",function(a){var n=a.val();DBData=Object.keys(n).map(function(t){return{id:t,data:n[t]}}),t&&e(DBData)})})};
$(document).ready(function(){translateInit()});